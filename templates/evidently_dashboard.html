<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidently AI Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .reports-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .report-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .report-item:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-ok {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Evidently AI Monitoring Dashboard</h1>
        <p>Real-time ML Model and Data Monitoring</p>
    </div>

    <div class="container">
        <!-- Quick Actions -->
        <div class="card">
            <h3>Quick Actions</h3>
            <button class="btn" onclick="runMonitoring()">üöÄ Run Monitoring Now</button>
            <button class="btn" onclick="refreshDashboard()" style="margin-left: 10px;">üîÑ Refresh Dashboard</button>
        </div>

        <!-- Status Overview -->
        <div class="card">
            <h3>Current Status</h3>
            <div id="statusOverview" class="loading">Loading status...</div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be populated by JavaScript -->
        </div>

        <!-- Drift Trend Chart -->
        <div class="card">
            <h3>üìà Data Drift Trend (Last 7 Days)</h3>
            <div class="chart-container">
                <canvas id="driftTrendChart"></canvas>
            </div>
        </div>

        <!-- Recent Reports -->
        <div class="card">
            <h3>üìã Recent Monitoring Reports</h3>
            <div id="reportsList" class="reports-list loading">Loading reports...</div>
        </div>

        <!-- Report Details Modal -->
        <div id="reportModal" style="display: none;">
            <div class="card">
                <h3>Report Details</h3>
                <div id="reportDetails"></div>
                <button class="btn" onclick="closeReportModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let driftChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            setInterval(refreshDashboard, 60000); // Refresh every minute
        });

        async function refreshDashboard() {
            try {
                await Promise.all([
                    loadReports(),
                    loadDriftSummary(),
                    updateStatusOverview()
                ]);
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
            }
        }

        async function loadReports() {
            try {
                const response = await fetch('/api/evidently/reports');
                const data = await response.json();
                
                const reportsList = document.getElementById('reportsList');
                
                if (data.reports && data.reports.length > 0) {
                    reportsList.innerHTML = data.reports.map(report => `
                        <div class="report-item" onclick="viewReport('${report.filename}')">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div>
                                    <strong>${report.filename}</strong>
                                    <br>
                                    <small>${new Date(report.timestamp).toLocaleString()}</small>
                                </div>
                                <div>
                                    ${getStatusBadge(report.summary)}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    reportsList.innerHTML = '<p>No reports available</p>';
                }
            } catch (error) {
                document.getElementById('reportsList').innerHTML = '<p>Error loading reports</p>';
            }
        }

        async function loadDriftSummary() {
            try {
                const response = await fetch('/api/evidently/drift-summary');
                const data = await response.json();
                
                if (data.drift_summary && data.drift_summary.length > 0) {
                    updateDriftChart(data.drift_summary);
                    updateMetrics(data.drift_summary);
                }
            } catch (error) {
                console.error('Error loading drift summary:', error);
            }
        }

        function updateDriftChart(driftData) {
            const ctx = document.getElementById('driftTrendChart').getContext('2d');
            
            if (driftChart) {
                driftChart.destroy();
            }

            const labels = driftData.map(d => new Date(d.timestamp).toLocaleDateString());
            const driftScores = driftData.map(d => d.drift_score);
            const driftDetected = driftData.map(d => d.drift_detected ? 1 : 0);

            driftChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Drift Score',
                        data: driftScores,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Drift Detected',
                        data: driftDetected,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        type: 'bar',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Drift Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            max: 1,
                            title: {
                                display: true,
                                text: 'Drift Detected'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function updateMetrics(driftData) {
            const latest = driftData[driftData.length - 1];
            const driftCount = driftData.filter(d => d.drift_detected).length;
            const avgDriftScore = driftData.reduce((sum, d) => sum + d.drift_score, 0) / driftData.length;

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${latest ? latest.drift_score.toFixed(3) : 'N/A'}</div>
                    <div class="metric-label">Latest Drift Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${driftCount}</div>
                    <div class="metric-label">Drift Incidents (7 days)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${avgDriftScore.toFixed(3)}</div>
                    <div class="metric-label">Avg Drift Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${latest ? latest.drifted_columns : 'N/A'}</div>
                    <div class="metric-label">Drifted Columns</div>
                </div>
            `;
        }

        function updateStatusOverview() {
            // This would be populated with real-time status
            const statusOverview = document.getElementById('statusOverview');
            statusOverview.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Monitoring system is operational
                </div>
                <p>Last update: ${new Date().toLocaleString()}</p>
            `;
        }

        function getStatusBadge(summary) {
            if (!summary) return '<span class="status-badge status-ok">Unknown</span>';
            
            if (summary.needs_attention) {
                return '<span class="status-badge status-error">‚ö†Ô∏è Needs Attention</span>';
            } else if (summary.drift_detected) {
                return '<span class="status-badge status-warning">üìä Drift Detected</span>';
            } else {
                return '<span class="status-badge status-ok">‚úÖ OK</span>';
            }
        }

        async function runMonitoring() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'üîÑ Running...';
            
            try {
                const response = await fetch('/api/evidently/run-monitoring', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Monitoring completed successfully!');
                    refreshDashboard();
                } else {
                    alert('‚ùå Monitoring failed: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error running monitoring: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Run Monitoring Now';
            }
        }

        async function viewReport(filename) {
            try {
                const response = await fetch(`/api/evidently/report/${filename}`);
                const report = await response.json();
                
                // Simple report display - you can enhance this
                const details = document.getElementById('reportDetails');
                details.innerHTML = `
                    <h4>Report: ${filename}</h4>
                    <pre>${JSON.stringify(report, null, 2)}</pre>
                `;
                
                document.getElementById('reportModal').style.display = 'block';
            } catch (error) {
                alert('Error loading report: ' + error.message);
            }
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }
    </script>
</body>
</html>
